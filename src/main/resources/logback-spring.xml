<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- Human-readable log pattern for local dev -->
    <property name="LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{correlationId:-NO-CORRELATION-ID}] %logger{36} - %msg%n"/>

    <!-- ===============================
         Console Appenders
    ================================ -->

    <!-- Dev console - pretty format -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- JSON console (for prod/Loki) -->
    <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeContext>false</includeContext>
            <includeMdc>true</includeMdc>
            <customFields>{"service":"docker-demo-app","version":"v6","environment":"${ENVIRONMENT:-dev}","host":"${HOSTNAME:-localhost}"}</customFields>
        </encoder>
    </appender>

    <!-- ===============================
         File Appenders
    ================================ -->

    <!-- Human-readable file logs -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/application.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- JSON file logs for ingestion -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/application-json.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeContext>false</includeContext>
            <includeMdc>true</includeMdc>
            <customFields>{"service":"docker-demo-app","version":"v6","environment":"${ENVIRONMENT:-dev}","host":"${HOSTNAME:-localhost}"}</customFields>
        </encoder>
    </appender>

    <!-- Separate error file for easier debugging in prod -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/errors.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/errors.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
    </appender>

    <!-- ===============================
         Async Wrappers (for performance)
    ================================ -->
    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="JSON_FILE"/>
        <queueSize>1024</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
    </appender>

    <!-- ===============================
         Spring Profiles
    ================================ -->

    <!-- Dev / non-prod -->
    <springProfile name="!prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>

        <!-- Debug your own code easily in non-prod -->
        <logger name="com.docker.demo" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </logger>
    </springProfile>

    <!-- Prod / Loki JSON logs -->
    <springProfile name="prod,loki">
        <root level="WARN">
            <appender-ref ref="JSON_CONSOLE"/>
            <appender-ref ref="ASYNC_JSON"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>

        <!-- Application logs at INFO in production -->
        <logger name="com.docker.demo" level="INFO" additivity="false">
            <appender-ref ref="JSON_CONSOLE"/>
            <appender-ref ref="ASYNC_JSON"/>
        </logger>
    </springProfile>

    <!-- ===============================
         Reduce Noise from 3rd-Party Logs
    ================================ -->
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.boot" level="INFO"/>
    <logger name="org.apache.http" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="org.springframework.web.client.RestTemplate" level="DEBUG"/>

</configuration>
